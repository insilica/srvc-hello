<html>
<head>
<link href="public/recogito-js-1.7.1/recogito.min.css" rel="stylesheet">
<script src="public/recogito-js-1.7.1/recogito.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet">
<style>html, body {
  padding:10px 20px;
  margin:0;
}

h1 {
  font-size:22px;
  margin-top:30px;
  margin-bottom:20px;
}

#outer-container {
  position:relative;
}

#content {
  max-width:920px;
  font-family:'Lato', sans-serif;
  font-size:17px;
  line-height:27px;
}
</style>
</head>
<body>
<div id="outer-container">
  <div id="recogito"></div>
</div>
<hr>
<div>
  <button id="recogito-submit" type="submit">Submit</button>
</div>
<script type="text/javascript">
    (function() {
      var config = null
      var currentDoc = null
      var el = document.getElementById('recogito')
      var submit = document.getElementById('recogito-submit')

      var r = Recogito.init({
        content: el
      })

      var loadConfig = function () {
        var req = new XMLHttpRequest()
        req.addEventListener("load", function (resp) {
          config = JSON.parse(req.response)
        })
        req.open("GET", "/config")
        req.send()
      }

      var loadCurrentDoc = function () {
        var req = new XMLHttpRequest()
        req.addEventListener("load", function (resp) {
          r.clearAnnotations()
          currentDoc = JSON.parse(req.response)
          el.innerText = currentDoc['data']['abstract']
        })
        req.open("GET", "/current-doc")
        req.send()
      }

      var submitDoc = function() {
        var req = new XMLHttpRequest()
        req.addEventListener("load", function (resp) {
          loadCurrentDoc()
        })
        req.open("POST", "/submit-label-answers")
        var answer = {"data": {"answer": r.getAnnotations(),
                               "document": currentDoc.hash,
                               "label": config.current_labels[0].hash,
                               "reviewer": config.reviewer,
                               "timestamp": Math.floor(Date.now() / 1000)},
                      "type": "label-answer"}
        req.send(JSON.stringify([answer]))
      }

      submit.addEventListener("click", submitDoc)

      loadConfig()
      loadCurrentDoc()
    })();
  </script>
</body>
</html>
